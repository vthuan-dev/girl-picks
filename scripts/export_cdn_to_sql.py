import mysql.connector
import json
import os
from pathlib import Path
from dotenv import load_dotenv

# Load environment variables from backend/.env
env_path = Path(__file__).parent.parent / 'backend' / '.env'
load_dotenv(dotenv_path=env_path)

DB_CONFIG = {
    'host': os.getenv('DATABASE_URL', '').split('@')[-1].split(':')[0] or 'localhost',
    'user': os.getenv('DATABASE_URL', '').split('://')[1].split(':')[0] if '://' in os.getenv('DATABASE_URL', '') else 'root',
    'password': os.getenv('DATABASE_URL', '').split(':')[2].split('@')[0] if ':' in os.getenv('DATABASE_URL', '') else '1001',
    'database': os.getenv('DATABASE_URL', '').split('/')[-1].split('?')[0] or 'girl_pick_db',
    'port': 3306
}

# Manual override if env parsing fails or is different for local
DB_CONFIG['password'] = '1001'
DB_CONFIG['database'] = 'girl_pick_db'

OUTPUT_FILE = Path(__file__).parent / 'sync_cdn_to_vps.sql'

def export_cdn_sql():
    print(f"üîç ƒêang k·∫øt n·ªëi t·ªõi Database Local: {DB_CONFIG['database']}...")
    try:
        connection = mysql.connector.connect(**DB_CONFIG)
        cursor = connection.cursor(dictionary=True)
        
        # L·∫•y to√†n b·ªô th√¥ng tin b·∫£ng girls cho nh·ªØng b·∫£n ghi ƒë√£ migrate
        query = "SELECT * FROM girls WHERE images LIKE '%girlpick.b-cdn.net%'"
        cursor.execute(query)
        rows = cursor.fetchall()
        
        if not rows:
            print("‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o c√≥ link CDN ·ªü Local.")
            return

        columns = [i[0] for i in cursor.description]
        print(f"üì¶ T√¨m th·∫•y {len(rows)} b·∫£n ghi. ƒêang t·∫°o file SQL ƒë·ªìng b·ªô TO√ÄN B·ªò c·ªôt...")
        
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            f.write("-- SQL Full Sync Script generated for girls table\n")
            f.write("-- Generated by Antigravity\n\n")
            f.write("SET FOREIGN_KEY_CHECKS = 0;\n")
            f.write("USE girl_pick_db;\n\n")
            
            for row in rows:
                # S·ª≠ d·ª•ng REPLACE INTO ƒë·ªÉ ghi ƒë√® to√†n b·ªô th√¥ng tin n·∫øu ID ƒë√£ t·ªìn t·∫°i
                vals = []
                for col in columns:
                    val = row[col]
                    if val is None:
                        vals.append("NULL")
                    elif isinstance(val, (int, float)):
                        vals.append(str(val))
                    elif isinstance(val, (dict, list)): # Cho tr∆∞·ªùng JSON images
                        json_val = json.dumps(val, ensure_ascii=False).replace("'", "''")
                        vals.append(f"'{json_val}'")
                    else:
                        # Escape single quotes in strings
                        str_val = str(val).replace("'", "''")
                        vals.append(f"'{str_val}'")
                
                col_names = ", ".join([f"`{c}`" for c in columns])
                val_placeholders = ", ".join(vals)
                sql = f"REPLACE INTO girls ({col_names}) VALUES ({val_placeholders});\n"
                f.write(sql)
            
            f.write("\nSET FOREIGN_KEY_CHECKS = 1;\n")
                
        print(f"‚úÖ Th√†nh c√¥ng! ƒê√£ t·∫°o file: {OUTPUT_FILE.absolute()}")
        print(f"üëâ Ch√∫ √Ω: L·ªánh REPLACE INTO s·∫Ω ghi ƒë√® TO√ÄN B·ªò d·ªØ li·ªáu c·ªßa c√°c c√¥ g√°i n√†y tr√™n VPS b·∫±ng d·ªØ li·ªáu Local.")
                
        print(f"‚úÖ Th√†nh c√¥ng! ƒê√£ t·∫°o file: {OUTPUT_FILE.absolute()}")
        print(f"üëâ H∆∞·ªõng d·∫´n: B·∫°n ch·ªâ c·∫ßn copy n·ªôi dung file n√†y v√† ch·∫°y (Execute) tr√™n database VPS l√† xong.")
        
        cursor.close()
        connection.close()
        
    except Exception as e:
        print(f"‚ùå L·ªói: {e}")

if __name__ == "__main__":
    export_cdn_sql()
