// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  GIRL
  CUSTOMER
  STAFF_UPLOAD
}

enum PostStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  REJECTED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOMO
  ZALOPAY
  VNPAY
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  FAKE
  HARASSMENT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum NotificationType {
  POST_APPROVED
  POST_REJECTED
  REVIEW_APPROVED
  REVIEW_REJECTED
  COMMENT_REPLY
  NEW_MESSAGE
  GIRL_PENDING_APPROVAL
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  BOOKING_CREATED
  BOOKING_CONFIRMED
  BOOKING_REJECTED
  BOOKING_CANCELLED
  BOOKING_COMPLETED
  BOOKING_REMINDER
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  REPORT_PROCESSED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole @default(CUSTOMER)
  fullName  String
  phone     String?
  avatarUrl String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  girl             Girl?           @relation("GirlUser")
  managedGirls     Girl[]          @relation("GirlManager") // Girls managed by this user
  reviews          Review[]
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")
  notifications    Notification[]
  reports          Report[]        @relation("Reporter")
  reportedBy       Report[]        @relation("ReportedUser")
  blocks           Block[]         @relation("Blocker")
  blockedBy        Block[]         @relation("Blocked")
  favorites        Favorite[]
  viewHistory      ViewHistory[]
  reviewLikes      ReviewLike[]
  reviewComments   ReviewComment[]
  postLikes        PostLike[]
  postComments     PostComment[]
  posts            Post[]          @relation("PostAuthor")
  bookings         Booking[]       @relation("Customer")
  payments         Payment[]       @relation("Payments")
  auditLogs        AuditLog[]
  approvedPosts    Post[]          @relation("ApprovedBy")
  approvedReviews  Review[]        @relation("ApprovedBy")
  reviewedReports  Report[]        @relation("ReviewedBy")
  albums           Album[]         @relation("AlbumAuthor")
  managedChatSexGirls ChatSexGirl[] @relation("ChatSexGirlManager")
  chatSexReviews   ChatSexReview[] @relation("ChatSexReviews")

  @@map("users")
}

model Girl {
  id          String  @id @default(uuid())
  userId      String? @unique // Optional - Girl is a product, not a user
  managedById String? // User ID who manages this girl (STAFF_UPLOAD/ADMIN)

  // Basic Info
  name      String?
  slug      String? @unique // URL-friendly slug for SEO
  age       Int?
  bio       String?
  phone     String? // Phone number from crawler
  birthYear Int? // Birth year from crawler

  // Physical Info
  height       String? // e.g., "160cm"
  weight       String? // e.g., "52kg"
  measurements String? // e.g., "89-64-92"
  origin       String? // e.g., "Miền Tây"

  // Location
  districts Json    @default("[]") // Array of district IDs stored as JSON
  address   String? // Full address from crawler
  location  String? // e.g., "Sài Gòn/Bình Tân"
  province  String? // e.g., "Sài Gòn"

  // Pricing
  price String? // e.g., "200K"

  // Rating & Reviews
  ratingAverage Float @default(0)
  totalReviews  Int   @default(0)

  // Verification
  verificationStatus      VerificationStatus @default(PENDING)
  verificationDocuments   Json               @default("[]") // Array of document URLs stored as JSON
  verificationRequestedAt DateTime?
  verificationVerifiedAt  DateTime?
  // Reverification & identity
  idCardFrontUrl String?
  idCardBackUrl  String?
  selfieUrl      String?
  needsReverify  Boolean @default(false)

  // Statistics
  viewCount     Int @default(0)
  favoriteCount Int @default(0)

  // Flags
  isFeatured  Boolean @default(false)
  isPremium   Boolean @default(false)
  isActive    Boolean @default(true)
  isAvailable Boolean @default(true) // From crawler

  // Media & Content
  images   Json @default("[]") // Array of image URLs stored as JSON
  tags     Json @default("[]") // Array of tag strings from crawler
  services Json @default("[]") // Array of service strings (temporary, will move to relation)

  // Activity
  lastActiveAt DateTime?
  workingHours String? // e.g., "24/24"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user            User?            @relation("GirlUser", fields: [userId], references: [id], onDelete: SetNull)
  managedBy       User?            @relation("GirlManager", fields: [managedById], references: [id], onDelete: SetNull)
  posts           Post[]
  reviews         Review[]
  favorites       Favorite[]
  viewHistory     ViewHistory[]
  bookings        Booking[]        @relation("GirlBookings")
  servicePackages ServicePackage[]
  timeSlots       TimeSlot[]
  blockedDates    BlockedDate[]

  // Indexes for performance optimization
  @@index([isActive, isFeatured, ratingAverage]) // For list queries with sorting
  @@index([province, isActive]) // For province filter
  @@index([verificationStatus, isActive]) // For verification filter
  @@index([lastActiveAt]) // For sorting by last active
  @@index([isActive, ratingAverage]) // For rating filter
  @@map("girls")
}

model Post {
  id           String     @id @default(uuid())
  authorId     String // User ID who created the post (can be GIRL or CUSTOMER)
  girlId       String? // Optional: if post is related to a specific girl
  title        String
  slug         String?    @unique // URL-friendly slug for SEO
  content      String
  images       Json       @default("[]") // Array of image URLs stored as JSON
  status       PostStatus @default(PENDING)
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Video/Movie fields (for phim-sex)
  videoUrl     String? // Main video URL
  videoSources Json    @default("[]") // Array of {url, type, label, resolution} stored as JSON
  duration     String? // Video duration (e.g., "10:30")
  viewCount    Int     @default(0) // Number of views
  rating       Float? // Rating (0-5)
  categoryId   String? // Category ID (relation to Category)
  legacyCategory String? @map("category") // Giữ cột cũ nếu còn tồn tại trong DB để tránh drop dữ liệu
  tags         Json    @default("[]") // Array of tag strings stored as JSON
  poster       String? // Poster/thumbnail URL
  thumbnail    String? // Thumbnail URL

  // Relations
  author     User          @relation("PostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  girl       Girl?         @relation(fields: [girlId], references: [id], onDelete: SetNull)
  approvedBy User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
  category   Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  likes      PostLike[]
  comments   PostComment[]

  @@map("posts")
}

model Review {
  id           String       @id @default(uuid())
  customerId   String
  girlId       String
  title        String
  content      String
  rating       Int // 1-5
  images       Json         @default("[]") // Array of image URLs stored as JSON
  status       ReviewStatus @default(PENDING)
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  customer   User            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  girl       Girl            @relation(fields: [girlId], references: [id], onDelete: Cascade)
  approvedBy User?           @relation("ApprovedBy", fields: [approvedById], references: [id])
  likes      ReviewLike[]
  comments   ReviewComment[]

  @@map("reviews")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  message   String
  data      Json? // Additional metadata
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ReviewLike {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@map("review_likes")
}

model ReviewComment {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  content   String
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("review_comments")
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("post_likes")
}

model PostComment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  parentId  String? // For nested replies
  createdAt DateTime @default(now())

  post    Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  PostComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies PostComment[] @relation("CommentReplies")

  @@index([postId, parentId])
  @@map("post_comments")
}

model Report {
  id               String       @id @default(uuid())
  reporterId       String
  reportedUserId   String?
  reportedPostId   String?
  reportedReviewId String?
  reason           ReportReason
  description      String
  status           ReportStatus @default(PENDING)
  reviewedById     String?
  reviewedAt       DateTime?
  createdAt        DateTime     @default(now())

  // Relations
  reporter     User  @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser User? @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull)
  reviewedBy   User? @relation("ReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@map("reports")
}

model Block {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  // Relations
  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@map("blocks")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  girlId    String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  girl Girl @relation(fields: [girlId], references: [id], onDelete: Cascade)

  @@unique([userId, girlId])
  @@map("favorites")
}

model ViewHistory {
  id       String   @id @default(uuid())
  userId   String
  girlId   String
  viewedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  girl Girl @relation(fields: [girlId], references: [id], onDelete: Cascade)

  @@map("view_history")
}

model District {
  id        String   @id @default(uuid())
  name      String
  province  String // Sài Gòn, Bình Dương, Đồng Nai
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("districts")
}

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String
  targetType String // post, review, user, etc.
  targetId   String
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  // Relations
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

model Setting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt

  @@map("settings")
}

model EmailTemplate {
  id        String   @id @default(uuid())
  name      String   @unique
  subject   String
  bodyHtml  String
  bodyText  String
  variables Json? // Available variables
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// Booking Models
model Booking {
  id                 String        @id @default(uuid())
  customerId         String
  girlId             String
  servicePackageId   String?
  serviceType        String // drinking, dating, both
  bookingDate        DateTime
  duration           Int // hours
  location           String? // venue/address
  status             BookingStatus @default(PENDING)
  totalPrice         Float
  depositAmount      Float
  paymentStatus      PaymentStatus @default(PENDING)
  specialRequests    String?
  cancellationReason String?
  cancelledAt        DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  customer       User             @relation("Customer", fields: [customerId], references: [id], onDelete: Cascade)
  girl           Girl             @relation("GirlBookings", fields: [girlId], references: [id], onDelete: Cascade)
  servicePackage ServicePackage?  @relation(fields: [servicePackageId], references: [id])
  payments       Payment[]
  bookingHistory BookingHistory[]

  @@map("bookings")
}

model ServicePackage {
  id          String   @id @default(uuid())
  girlId      String
  name        String
  description String?
  duration    Int // hours
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  girl     Girl      @relation(fields: [girlId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@map("service_packages")
}

model TimeSlot {
  id          String   @id @default(uuid())
  girlId      String
  dayOfWeek   Int // 0-6 (Sunday-Saturday)
  startTime   String // HH:mm format
  endTime     String // HH:mm format
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  girl Girl @relation(fields: [girlId], references: [id], onDelete: Cascade)

  @@map("time_slots")
}

model BlockedDate {
  id        String   @id @default(uuid())
  girlId    String
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())

  // Relations
  girl Girl @relation(fields: [girlId], references: [id], onDelete: Cascade)

  @@unique([girlId, date])
  @@map("blocked_dates")
}

model BookingHistory {
  id        String        @id @default(uuid())
  bookingId String
  status    BookingStatus
  changedBy String?
  notes     String?
  createdAt DateTime      @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_history")
}

model Payment {
  id            String        @id @default(uuid())
  bookingId     String
  userId        String // Customer who made payment
  amount        Float
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)
  transactionId String?
  paymentDate   DateTime?
  refundAmount  Float?
  refundReason  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  booking        Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user           User             @relation("Payments", fields: [userId], references: [id], onDelete: Cascade)
  paymentHistory PaymentHistory[]

  @@map("payments")
}

model PaymentHistory {
  id        String        @id @default(uuid())
  paymentId String
  status    PaymentStatus
  amount    Float
  notes     String?
  createdAt DateTime      @default(now())

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("payment_history")
}

model Album {
  id          String   @id @default(uuid())
  title       String
  description String?
  coverUrl    String?
  category    String?
  albumCategoryId String?
  tags        Json?
  isPublic    Boolean  @default(true)
  viewCount   Int      @default(0)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy   User     @relation("AlbumAuthor", fields: [createdById], references: [id])
  categoryRef AlbumCategory? @relation(fields: [albumCategoryId], references: [id], onDelete: SetNull)
  images      AlbumImage[]

  @@map("albums")
}

model AlbumImage {
  id        String   @id @default(uuid())
  albumId   String
  url       String
  thumbUrl  String?
  caption   String?
  sortOrder Int      @default(0) @map("order")
  createdAt DateTime @default(now())

  album     Album    @relation(fields: [albumId], references: [id], onDelete: Cascade)

  @@map("album_images")
}

model AlbumCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String?  @unique
  description String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  albums    Album[]

  @@map("album_categories")
}

model Venue {
  id         String   @id @default(uuid())
  name       String
  address    String
  districtId String?
  latitude   Float?
  longitude  Float?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("venues")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique // Category name (e.g., "sex tự quay", "sex nhật bản")
  slug        String   @unique // URL-friendly slug
  description String? // Optional description
  isActive    Boolean  @default(true)
  order       Int      @default(0) // Display order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts Post[]

  @@map("categories")
}

model PageView {
  id        String   @id @default(uuid())
  path      String // Page path (e.g., "/", "/girls", "/search")
  title     String? // Page title
  referrer  String? // Referrer URL
  userAgent String? // User agent string
  sessionId String // Session ID to track unique sessions
  userId    String? // User ID if logged in
  ipAddress String? // IP address
  createdAt DateTime @default(now())

  @@index([path])
  @@index([sessionId])
  @@index([createdAt])
  @@index([userId])
  @@map("page_views")
}

model ChatSexGirl {
  id          String   @id @default(uuid())
  managedById String?  // Admin/Staff who created this (not a user account)
  
  // Basic Info
  name        String
  slug        String?  @unique // URL-friendly slug for SEO
  title       String?  // Title from crawler
  age         Int?
  birthYear   Int?     // Năm sinh
  height      String?  // Chiều cao (e.g., "158cm")
  weight      String?  // Cân nặng (e.g., "47kg")
  bio         String?  // Description
  phone       String?  // Phone number
  zalo        String?  // Zalo ID
  telegram    String?  // Telegram ID
  
  // Location
  location    String?
  province    String?
  address     String?
  
  // Pricing & Services
  price       String?  // e.g., "15", "500k"
  price15min  String?  // Giá 15 phút (e.g., "200K")
  paymentInfo String?  // Thông tin thanh toán (e.g., "Teckcombank 9022")
  services    Json     @default("[]") // Array of service strings
  workingHours String? // e.g., "24/7", "9h-2h tối"
  instruction String?  // Hướng dẫn
  
  // Media
  images      Json     @default("[]") // Array of image URLs
  videos      Json?    // Array of video URLs (multiple qualities) - nullable, no default
  coverImage  String?  // First image as cover
  
  // Status & Flags
  isVerified  Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  isActive    Boolean  @default(true)
  isAvailable Boolean  @default(true)
  
  // Statistics
  viewCount   Int      @default(0)
  rating      Float?   // Rating if available
  
  // Metadata
  tags        Json     @default("[]") // Array of tag strings
  sourceUrl   String?  @db.Text // Original URL from crawler (can be long)
  crawledAt   DateTime? // When data was crawled
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  managedBy   User?    @relation("ChatSexGirlManager", fields: [managedById], references: [id], onDelete: SetNull)
  reviews     ChatSexReview[]
  
  @@index([isActive, isFeatured])
  @@index([province, isActive])
  @@index([isActive, viewCount])
  @@map("chat_sex_girls")
}

model ChatSexReview {
  id        String   @id @default(uuid())
  girlId    String   @map("girl_id")
  userId    String?  @map("user_id")
  
  // Review content
  rating    Int      // 1-5 stars
  comment   String?  @db.Text
  
  // User info (for anonymous reviews)
  userName  String?  @map("user_name")
  
  // Status
  isApproved Boolean @default(true) @map("is_approved") // Auto-approve for now
  isActive   Boolean @default(true) @map("is_active")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  girl      ChatSexGirl @relation(fields: [girlId], references: [id], onDelete: Cascade)
  user      User?       @relation("ChatSexReviews", fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("chat_sex_reviews")
  @@index([girlId])
  @@index([userId])
  @@index([isApproved, isActive])
}
