name: Deploy to VPS

on:
  push:
    branches:
      - master
      - neww

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Build Backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd backend
          npm ci
          npx prisma generate
          npm run build
          # Keep only production dependencies
          npm prune --production

      - name: Build Frontend
        env:
          NEXT_PUBLIC_API_URL: https://gaigo1.net/api
          NEXT_PUBLIC_SITE_URL: https://gaigo1.net
          NEXT_DISABLE_TYPECHECK: 1
          NEXT_DISABLE_ESLINT: 1
        run: |
          cd frontend
          npm ci
          npm run build
          # Keep only production dependencies
          npm prune --production

      - name: Prepare Artifacts
        run: |
          mkdir -p deploy
          # Copy Backend
          mkdir -p deploy/backend
          cp -r backend/dist deploy/backend/
          cp -r backend/node_modules deploy/backend/
          cp -r backend/prisma deploy/backend/
          cp backend/package.json deploy/backend/
          
          # Copy Frontend
          mkdir -p deploy/frontend
          cp -r frontend/.next deploy/frontend/
          cp -r frontend/public deploy/frontend/
          cp -r frontend/node_modules deploy/frontend/
          cp frontend/package.json deploy/frontend/
          cp frontend/next.config.js deploy/frontend/ || true
          
          # Copy Nginx & Env helpers
          cp -r nginx deploy/ || true
          
          # Compress everything
          tar -czf deploy.tar.gz -C deploy .

      - name: Upload to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: Execute Remote Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            APP_DIR=/var/www/girl-pick
            mkdir -p $APP_DIR
            
            echo "==> Extracting artifacts"
            tar -xzf /tmp/deploy.tar.gz -C $APP_DIR
            rm /tmp/deploy.tar.gz
            
            cd $APP_DIR
            
            echo "==> Writing production env file"
            cat > .env.production <<'EOF'
            ${{ secrets.ENV_PRODUCTION }}
            EOF

            # Export env for migrations
            set -a
            . ./.env.production
            set +a

            echo "==> Applying database migrations"
            cd backend
            npx prisma migrate deploy
            
            echo "==> Restarting services with PM2"
            pm2 delete girl-pick-backend || true
            pm2 delete girl-pick-frontend || true
            
            # Start Backend
            CORS_ORIGIN=http://gaigo1.net,http://www.gaigo1.net,https://gaigo1.net,https://www.gaigo1.net pm2 start "npm run start:prod" --name girl-pick-backend --time
            
            # Start Frontend
            cd $APP_DIR/frontend
            PORT=3000 HOST=0.0.0.0 pm2 start "npm run start" --name girl-pick-frontend --time --env production
            
            pm2 save
            
            echo "==> Ensuring Nginx and Firewall"
            # Nginx config update if needed (similar to previous script but simplified)
            if [ -d "$APP_DIR/nginx" ] && [ -f "$APP_DIR/nginx/gaigo1.net.conf" ]; then
              if ! grep -q "listen 443 ssl" /etc/nginx/sites-enabled/gaigo1.net 2>/dev/null; then
                cp "$APP_DIR/nginx/gaigo1.net.conf" /etc/nginx/sites-available/gaigo1.net
                ln -sf /etc/nginx/sites-available/gaigo1.net /etc/nginx/sites-enabled/
                rm -f /etc/nginx/sites-enabled/default
                nginx -t && systemctl reload nginx || true
              fi
            fi
            
            if command -v ufw >/dev/null 2>&1; then
              ufw allow 80/tcp || true
              ufw allow 443/tcp || true
            fi
            
            echo "âœ“ Deployment finished successfully."
