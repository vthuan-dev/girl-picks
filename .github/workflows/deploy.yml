name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            APP_DIR=/var/www/girl-pick
            REPO_URL=https://github.com/vthuan-dev/girl-picks.git

            echo "==> Ensuring base dependencies (Node 20, npm, pm2, git, build tools, nginx)"
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get update -y
              apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi
            if ! command -v git >/dev/null 2>&1; then
              apt-get update -y
              apt-get install -y git build-essential
            fi
            if ! command -v nginx >/dev/null 2>&1; then
              apt-get update -y
              apt-get install -y nginx
            fi

            echo "==> Cloning or updating repository"
            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            else
              cd "$APP_DIR"
              git fetch --all --prune
              git reset --hard origin/master
            fi

            cd "$APP_DIR"

            echo "==> Writing production env file"
            cat > .env.production <<'EOF'
            ${{ secrets.ENV_PRODUCTION }}
            EOF

            # Export env for this session (used by build/migrate steps)
            set -a
            . ./.env.production
            set +a

            echo "==> Backend install, migrate, build"
            cd "$APP_DIR/backend"
            npm ci
            npx prisma migrate deploy
            npm run build

            echo "==> Restart backend with PM2"
            pm2 delete girl-pick-backend || true
            # Load env vars and start backend with CORS_ORIGIN
            cd "$APP_DIR"
            set -a
            . ./.env.production
            set +a
            cd "$APP_DIR/backend"
            CORS_ORIGIN=http://gaigo1.net,http://www.gaigo1.net,https://gaigo1.net,https://www.gaigo1.net pm2 start "npm run start:prod" --name girl-pick-backend --time
            
            # Wait a moment and check if backend started
            sleep 3
            if ! pm2 list | grep -q "girl-pick-backend.*online"; then
              echo "⚠ Backend failed to start, checking logs..."
              pm2 logs girl-pick-backend --lines 20 --nostream
              exit 1
            fi
            echo "✓ Backend started successfully"

            echo "==> Frontend install and build"
            cd "$APP_DIR/frontend"

            # Remove old build cache and env files
            rm -rf .next .env .env.local .env.development

            # Create frontend .env.production with domain (use HTTPS if SSL is configured)
            echo "NEXT_PUBLIC_API_URL=https://gaigo1.net/api" > .env.production
            echo "NEXT_PUBLIC_SITE_URL=https://gaigo1.net" >> .env.production
            echo "PORT=3000" >> .env.production
            echo "HOST=0.0.0.0" >> .env.production
            echo "NODE_ENV=production" >> .env.production

            npm ci
            
            # Build with explicit env vars (build traces error is non-critical if .next exists)
            NEXT_PUBLIC_API_URL=https://gaigo1.net/api NEXT_PUBLIC_SITE_URL=https://gaigo1.net npm run build || {
              echo "Build completed with warnings, checking if .next directory exists..."
              if [ -d ".next" ]; then
                echo "✓ Build output exists, continuing despite warnings..."
              else
                echo "✗ Build failed completely, exiting..."
                exit 1
              fi
            }

            echo "==> Restart frontend with PM2"
            pm2 delete girl-pick-frontend || true
            cd "$APP_DIR/frontend"
            PORT=3000 HOST=0.0.0.0 pm2 start "npm run start" --name girl-pick-frontend --time --env production
            
            # Wait a moment and check if frontend started
            sleep 3
            if ! pm2 list | grep -q "girl-pick-frontend.*online"; then
              echo "⚠ Frontend failed to start, checking logs..."
              pm2 logs girl-pick-frontend --lines 20 --nostream
              exit 1
            fi
            echo "✓ Frontend started successfully"

            pm2 save

            echo "==> Configure Nginx reverse proxy"
            if [ -f "$APP_DIR/nginx/gaigo1.net.conf" ]; then
              cp "$APP_DIR/nginx/gaigo1.net.conf" /etc/nginx/sites-available/gaigo1.net
              ln -sf /etc/nginx/sites-available/gaigo1.net /etc/nginx/sites-enabled/
              # Remove default nginx site if it exists
              rm -f /etc/nginx/sites-enabled/default
              # Test nginx configuration
              if ! nginx -t; then
                echo "✗ Nginx configuration test failed!"
                exit 1
              fi
              # Reload nginx
              if ! systemctl reload nginx 2>/dev/null; then
                echo "Reload failed, trying restart..."
                systemctl restart nginx
              fi
              # Verify nginx is running
              if systemctl is-active --quiet nginx; then
                echo "✓ Nginx configured and running successfully"
              else
                echo "✗ Nginx failed to start!"
                systemctl status nginx --no-pager
                exit 1
              fi
            else
              echo "Warning: Nginx config file not found at $APP_DIR/nginx/gaigo1.net.conf"
            fi

            echo "==> Ensure firewall allows HTTP/HTTPS"
            if command -v ufw >/dev/null 2>&1; then
              ufw allow 80/tcp || true
              ufw allow 443/tcp || true
            fi

            echo "Deployment finished."