name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            APP_DIR=/var/www/girl-pick
            REPO_URL=https://github.com/vthuan-dev/girl-picks.git

            echo "==> Ensuring base dependencies (Node 20, npm, pm2, git, build tools)"
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get update -y
              apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi
            if ! command -v git >/dev/null 2>&1; then
              apt-get update -y
              apt-get install -y git build-essential
            fi

            echo "==> Cloning or updating repository"
            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            else
              cd "$APP_DIR"
              git fetch --all --prune
              git reset --hard origin/master
            fi

            cd "$APP_DIR"

            echo "==> Writing production env file"
            cat > .env.production <<'EOF'
            ${{ secrets.ENV_PRODUCTION }}
            EOF

            # Export env for this session (used by build/migrate steps)
            set -a
            . ./.env.production
            set +a

            echo "==> Backend install, migrate, build"
            cd "$APP_DIR/backend"
            npm ci
            npx prisma migrate deploy
            npm run build

            echo "==> Restart backend with PM2"
            pm2 delete girl-pick-backend || true
            pm2 start "npm run start:prod" --name girl-pick-backend --time --cwd "$APP_DIR/backend"

            echo "==> Frontend install and build"
            cd "$APP_DIR/frontend"
            npm ci
            npm run build

            echo "==> Restart frontend with PM2"
            pm2 delete girl-pick-frontend || true
            PORT=${PORT:-3000} HOST=${HOST:-0.0.0.0} pm2 start "npm run start" --name girl-pick-frontend --time --cwd "$APP_DIR/frontend" --env production

            pm2 save

            echo "Deployment finished."